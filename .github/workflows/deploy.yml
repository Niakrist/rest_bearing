name: Deploy Express Backend

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting backend deployment..."
          echo "================================"
          
          # ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ Node.js (Ñ‚Ğ°ĞºĞ°Ñ Ğ¶Ğµ Ğ²ĞµÑ€ÑĞ¸Ñ ĞºĞ°Ğº Ñƒ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ°)
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm use 22.14.0
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ backend
          cd /root/projects/backend
          echo "ğŸ“‚ Working in: $(pwd)"
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
          echo "ğŸ“¥ Fetching latest code..."
          git fetch origin
          git reset --hard origin/master
          echo "âœ… Code updated to: $(git log --oneline -1)"
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ production)
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --only=production
          
          # ğŸ”„ Ğ’ĞĞ–ĞĞ: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ .env Ñ„Ğ°Ğ¹Ğ»
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ .env, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ - ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼
          if [ -f .env ]; then
            echo "ğŸ” Preserving existing .env file..."
            cp .env .env.backup_$(date +%s)
          else
            echo "âš ï¸  Warning: .env file not found!"
          fi
          
          # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ñ‡ĞµÑ€ĞµĞ· PM2
          echo "ğŸ”„ Restarting backend..."
          pm2 restart rvz-backend
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ»ÑÑ
          echo "ğŸ¥ Health check..."
          sleep 3  # Ğ”Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞº
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ±ÑĞºĞµĞ½Ğ´Ğ°
          if curl -s -f http://localhost:4000/api/v1/ > /dev/null; then
            echo "âœ… Backend is responding at http://localhost:4000"
          else
            echo "âš ï¸  Backend check failed, but deployment completed"
            echo "    Check manually: curl http://localhost:4000/api/v1/"
          fi
          
          echo "âœ… Backend deployment completed!"
          echo "â° Finished at: $(date)"
          echo ""
          echo "ğŸ“Š PM2 status:"
          pm2 list | grep rvz-backend
